# SABER咨询网站 - 阿里云服务器部署指南

## 🚀 部署方案选择

### 方案一：Git部署（推荐）
- ✅ 便于维护和更新
- ✅ 支持版本控制
- ✅ 适合团队协作
- ✅ 自动化部署

### 方案二：打包传输
- ✅ 一次性部署
- ✅ 网络环境受限时适用
- ✅ 简单直接

---

## 📦 方案一：Git部署（推荐）

### 1. 本地准备

#### 1.1 初始化Git仓库
```bash
# 在项目根目录执行
git init
git add .
git commit -m "Initial commit"
```

#### 1.2 创建远程仓库
选择以下任一平台：
- **GitHub**: https://github.com
- **GitLab**: https://gitlab.com  
- **Gitee**: https://gitee.com
- **阿里云Code**: https://codeup.aliyun.com

#### 1.3 推送代码
```bash
git remote add origin <your-repository-url>
git push -u origin main
```

### 2. 阿里云服务器准备

#### 2.1 连接服务器
```bash
ssh root@your-server-ip
```

#### 2.2 安装必要软件
```bash
# 更新系统
yum update -y  # CentOS
# 或
apt update && apt upgrade -y  # Ubuntu

# 安装Node.js
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
yum install -y nodejs

# 安装MySQL
yum install -y mysql-server mysql
systemctl start mysqld
systemctl enable mysqld

# 安装Nginx（可选，用于反向代理）
yum install -y nginx
systemctl start nginx
systemctl enable nginx

# 安装Git
yum install -y git
```

#### 2.3 配置MySQL
```bash
# 安全配置
mysql_secure_installation

# 创建数据库
mysql -u root -p
CREATE DATABASE saber_consulting CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'saber_user'@'localhost' IDENTIFIED BY 'your-password';
GRANT ALL PRIVILEGES ON saber_consulting.* TO 'saber_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 3. 部署项目

#### 3.1 克隆项目
```bash
cd /opt
git clone <your-repository-url> saber-consulting
cd saber-consulting
```

#### 3.2 安装依赖
```bash
npm install --production
```

#### 3.3 配置环境变量
```bash
cp env.example .env
nano .env
```

编辑 `.env` 文件，配置以下内容：
```env
# 生产环境配置
NODE_ENV=production
PORT=3000

# 数据库配置
DB_HOST=localhost
DB_USER=saber_user
DB_PASSWORD=your-password
DB_NAME=saber_consulting
DB_PORT=3306

# 邮箱配置
QQ_EMAIL_PASS=your-qq-email-auth-code
HUAWEI_EMAIL_USER=your-email@your-domain.com
HUAWEI_EMAIL_PASS=your-huawei-email-auth-code

# 管理后台配置
ADMIN_USERNAME=Sy321098
ADMIN_PASSWORD=Sy098321

# 安全配置
JWT_SECRET=your-production-jwt-secret-key
SESSION_SECRET=your-production-session-secret-key

# 邮件通知配置
EMAIL_NOTIFICATIONS=true
RECEIVE_EMAIL=shen.5109256@qq.com
```

#### 3.4 初始化数据库
```bash
node scripts/init-database.js
```

#### 3.5 启动服务
```bash
# 安装PM2
npm install -g pm2

# 启动服务
pm2 start start.js --name "saber-consulting"

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup
```

### 4. 配置Nginx反向代理（推荐）

#### 4.1 创建Nginx配置
```bash
nano /etc/nginx/conf.d/saber-consulting.conf
```

添加以下内容：
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 4.2 重启Nginx
```bash
nginx -t
systemctl restart nginx
```

### 5. 配置防火墙
```bash
# 开放端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --reload
```

---

## 📦 方案二：打包传输

### 1. 本地打包

#### 1.1 运行部署脚本
```bash
# 在项目根目录执行
chmod +x deploy/deploy-to-aliyun.sh
./deploy/deploy-to-aliyun.sh
```

#### 1.2 上传到服务器
```bash
# 使用scp上传
scp saber-deploy-*.tar.gz root@your-server-ip:/opt/

# 或使用其他工具上传
```

### 2. 服务器部署

#### 2.1 解压文件
```bash
cd /opt
tar -xzf saber-deploy-*.tar.gz
cd saber-deploy-*
```

#### 2.2 按照DEPLOY_README.md中的说明进行部署

---

## 🔧 维护和更新

### Git部署方式更新
```bash
# 本地更新代码
git add .
git commit -m "Update description"
git push origin main

# 服务器更新
cd /opt/saber-consulting
git pull origin main
npm install --production
pm2 restart saber-consulting
```

### 查看服务状态
```bash
# 查看PM2状态
pm2 status

# 查看日志
pm2 logs saber-consulting

# 重启服务
pm2 restart saber-consulting
```

### 数据库备份
```bash
# 备份数据库
mysqldump -u root -p saber_consulting > backup_$(date +%Y%m%d).sql

# 恢复数据库
mysql -u root -p saber_consulting < backup_20231201.sql
```

---

## 🌐 访问地址

部署完成后，可以通过以下地址访问：

- **网站首页**: http://your-server-ip:3000
- **管理后台**: http://your-server-ip:3000/admin
- **邮件测试**: http://your-server-ip:3000/test

如果配置了Nginx反向代理：
- **网站首页**: http://your-domain.com
- **管理后台**: http://your-domain.com/admin
- **邮件测试**: http://your-domain.com/test

---

## 📝 注意事项

1. **安全配置**
   - 修改默认的管理员密码
   - 配置强密码的JWT_SECRET和SESSION_SECRET
   - 定期更新系统和依赖包

2. **性能优化**
   - 使用Nginx反向代理
   - 配置静态文件缓存
   - 启用Gzip压缩

3. **监控和日志**
   - 使用PM2监控应用状态
   - 配置日志轮转
   - 设置告警机制

4. **备份策略**
   - 定期备份数据库
   - 备份配置文件
   - 测试恢复流程

---

## 🆘 常见问题

### Q: 端口被占用怎么办？
A: 修改.env文件中的PORT配置，或使用`netstat -tulpn | grep :3000`查看占用进程

### Q: 数据库连接失败？
A: 检查MySQL服务状态、用户名密码、数据库名称是否正确

### Q: 邮件发送失败？
A: 检查邮箱授权码配置、防火墙设置、SMTP端口是否开放

### Q: 服务无法启动？
A: 查看PM2日志：`pm2 logs saber-consulting`

---

## 📞 技术支持

如遇到问题，请检查：
1. 服务器日志
2. 应用日志
3. 网络连接
4. 配置文件

建议使用Git部署方式，便于问题排查和版本回滚。
